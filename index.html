<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitLab Pipeline Monitor</title>
  
  <!-- Sakura.css - Classless CSS framework -->
  <link rel="stylesheet" href="https://unpkg.com/sakura.css/css/sakura.css" type="text/css">
  
  <!-- htmx -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <!-- htmx client-side templates extension -->
  <script src="https://unpkg.com/htmx.org/dist/ext/client-side-templates.js"></script>
  <!-- Mustache for client-side templates -->
  <script src="https://unpkg.com/mustache@4.2.0/mustache.min.js"></script>
  
  <!-- hyperscript -->
  <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
  
  <style>
    /* Minimal custom styles */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    .loading { text-align: center; padding: 2rem; }
    
    /* Status badges */
    mark[data-status] { padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.85rem; font-weight: 600; }
    mark[data-status="success"] { background: #16a34a; color: #fff; }
    mark[data-status="success"]::before { content: "ðŸŸ¢ "; }
    mark[data-status="failed"] { background: #dc2626; color: #fff; }
    mark[data-status="failed"]::before { content: "ðŸ”´ "; }
    mark[data-status="running"] { background: #2563eb; color: #fff; }
    mark[data-status="running"]::before { content: "ðŸ”µ "; }
    mark[data-status="pending"] { background: #facc15; color: #111827; }
    mark[data-status="pending"]::before { content: "ðŸŸ¡ "; }
    mark[data-status="canceled"] { background: #6b7280; color: #fff; }
    mark[data-status="canceled"]::before { content: "âš« "; }
    mark[data-status="skipped"] { background: #9ca3af; color: #fff; }
    mark[data-status="skipped"]::before { content: "âšª "; }
    mark[data-status="manual"] { background: #9333ea; color: #fff; }
    mark[data-status="manual"]::before { content: "ðŸŸ£ "; }
    mark[data-status="none"] { background: #6b7280; color: #fff; }
    mark[data-status="none"]::before { content: "âšª "; }
    
    /* Simple project cards */
    article { border-left: 4px solid #ddd; margin: 1rem 0; }
    article[data-status="success"] { border-left-color: #16a34a; }
    article[data-status="failed"] { border-left-color: #dc2626; }
    article[data-status="running"] { border-left-color: #2563eb; }
    
    svg { max-width: 100%; height: auto; display: block; margin: 1rem 0; }

    /* Graph view layout (stages in columns) */
    .stages { display: flex; gap: 0.75rem; align-items: flex-start; }
    .stage { min-width: 160px; }
    .stage h4 { margin: 0 0 0.25rem 0; font-size: 0.95rem; }
    .jobs { display: flex; flex-direction: column; gap: 0.25rem; }
    .job-badge { font-size: 0.8rem; padding: 0.2rem 0.4rem; border-radius: 3px; background: #eee; }
    .job-badge.success { background: #dcfce7; color: #166534; }
    .job-badge.failed { background: #fee2e2; color: #991b1b; }
    .job-badge.running { background: #dbeafe; color: #1e40af; }
    .job-badge.pending { background: #fef3c7; color: #92400e; }
    .job-badge.canceled { background: #e5e7eb; color: #374151; }
    .job-badge.skipped { background: #e5e7eb; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <h1>ðŸš€ GitLab Pipeline Monitor</h1>
    <small id="cache-info"></small>
  </header>

  <nav>
    <button 
      hx-get="/api/pipelines?includeJobs=false"
      hx-target="#content"
      hx-ext="client-side-templates"
      mustache-template="tpl-list"
      _="on htmx:beforeRequest
           put '<div class=loading><div class=spinner></div><p>Cargando pipelines...</p></div>' into #content
         on htmx:afterOnLoad
           call window.updateCacheInfo(event.detail.xhr.responseText)">
      ðŸ“‹ Lista
    </button>

    <button 
      hx-get="/api/pipelines?includeJobs=true"
      hx-target="#content"
      hx-ext="client-side-templates"
      mustache-template="tpl-graph"
      _="on htmx:beforeRequest
           put '<div class=loading><div class=spinner></div><p>Cargando pipelines con jobs...</p></div>' into #content
         on htmx:afterOnLoad
           call window.updateCacheInfo(event.detail.xhr.responseText)">
      ðŸ“Š GrÃ¡fico
    </button>

    <button 
      hx-get="/api/pipelines?force=true&includeJobs=false"
      hx-target="#content"
      hx-ext="client-side-templates"
      mustache-template="tpl-list"
      _="on htmx:beforeRequest
           put '<div class=loading><div class=spinner></div><p>Refrescando...</p></div>' into #content
         on htmx:afterOnLoad
           call window.updateCacheInfo(event.detail.xhr.responseText)">
      ðŸ”„ Refresh
    </button>
  </nav>

  <main id="content">
    <div class="loading">
      <div class="spinner"></div>
      <p>Inicializando...</p>
    </div>
  </main>

  <!-- List View Template (Mustache) -->
  <script id="tpl-list" type="text/template">
    {{#data}}
      <section>
        <h2>{{serverName}}</h2>
        {{#projects}}
          <article>
            <h3><a href="{{url}}" target="_blank">{{name}}</a></h3>
            {{#error}}
              <p><em>Error: {{.}}</em></p>
            {{/error}}
            {{^error}}
              <table>
                <thead>
                  <tr><th>Branch</th><th>Pipeline</th><th>Commit</th></tr>
                </thead>
                <tbody>
                  {{#branches}}
                    <tr>
                      <td><code>{{name}}</code></td>
                      {{#pipeline}}
                        <td><a href="{{web_url}}" target="_blank"><mark data-status="{{status}}">{{status}}</mark></a></td>
                        <td><small title="{{commitTitle}}">{{commitShortId}}</small></td>
                      {{/pipeline}}
                      {{^pipeline}}
                        {{#error}}
                          <td colspan="2"><em>{{.}}</em></td>
                        {{/error}}
                        {{^error}}
                          <td><mark data-status="none">No Pipeline</mark></td>
                          <td></td>
                        {{/error}}
                      {{/pipeline}}
                    </tr>
                  {{/branches}}
                </tbody>
              </table>
            {{/error}}
          </article>
        {{/projects}}
      </section>
    {{/data}}
  </script>

  <!-- Graph View Template (Mustache) -->
  <script id="tpl-graph" type="text/template">
    {{#data}}
      <section>
        <h2>{{serverName}}</h2>
        {{#projects}}
          <article>
            <h3><a href="{{url}}" target="_blank">{{name}}</a></h3>
            {{#error}}
              <p><em>Error: {{.}}</em></p>
            {{/error}}
            {{^error}}
              {{#branches}}
                <details>
                  <summary><code>{{name}}</code> {{#pipeline}}<mark data-status="{{status}}">{{status}}</mark>{{/pipeline}}{{^pipeline}}<mark data-status="none">No Pipeline</mark>{{/pipeline}}</summary>
                  {{#pipeline}}
                    <div class="stages">
                      {{#stages}}
                        <div class="stage">
                          <h4>{{name}}</h4>
                          <div class="jobs">
                            {{#jobs}}
                              <a class="job-badge {{status}}" href="{{web_url}}" target="_blank" title="{{stage}}: {{name}} ({{status}})">{{name}}</a>
                            {{/jobs}}
                            {{^jobs}}
                              <small><em>No jobs</em></small>
                            {{/jobs}}
                          </div>
                        </div>
                      {{/stages}}
                      {{^stages}}
                        <p><em>Jobs list:</em></p>
                        <p>
                          {{#jobs}}<a class="job-badge {{status}}" href="{{web_url}}" target="_blank" title="{{stage}}: {{name}} ({{status}})">{{name}}</a> {{/jobs}}
                          {{^jobs}}<em>No jobs</em>{{/jobs}}
                        </p>
                      {{/stages}}
                    </div>
                  {{/pipeline}}
                </details>
              {{/branches}}
            {{/error}}
          </article>
        {{/projects}}
      </section>
    {{/data}}
  </script>

  <script src="/main.js" type="module"></script>
</body>
</html>
